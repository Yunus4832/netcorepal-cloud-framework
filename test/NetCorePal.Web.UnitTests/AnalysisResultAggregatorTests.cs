using NetCorePal.Extensions.CodeAnalysis;
using Xunit.Abstractions;
namespace NetCorePal.Web.UnitTests;

public class AnalysisResultAggregatorTests(ITestOutputHelper testOutputHelper)
{
    [Fact]
    public void Aggregate_ShouldCombineResults()
    {
        var result = AnalysisResultAggregator.Aggregate(
            typeof(Program).Assembly);

        // Assert

        Assert.NotEmpty(result.Controllers);
        Assert.NotEmpty(result.Commands);
        Assert.NotEmpty(result.Entities);
        Assert.NotEmpty(result.DomainEvents);
        Assert.NotEmpty(result.DomainEventHandlers);
        Assert.NotEmpty(result.IntegrationEvents);
        Assert.NotEmpty(result.IntegrationEventHandlers);
        Assert.NotEmpty(result.IntegrationEventConverters);
        Assert.NotEmpty(result.Relationships);

        var json = System.Text.Json.JsonSerializer.Serialize(result, new System.Text.Json.JsonSerializerOptions
        {
            WriteIndented = false
        });


        /* CodeFlowAnalysisResult 结果示例
         * {"Controllers":[{"Name":"OrderController","FullName":"NetCorePal.Web.Controllers.OrderController","Methods":["Get","Post","GetById","ListByPage","ListByPageSync","ListByPageRequest","ListByPageRequestASync","SetPaid","SetOrderItemName","SendEvent","KnownException","UnknownException","ServiceKnownException","ServiceUnknownException","BadRequest","PostBadRequest","Path","QueryOrderByName","DeleteOrder","GetByIdIgnoreQueryFilter"]},{"Name":"TestController","FullName":"NetCorePal.Web.Controllers.TestController","Methods":["Get","Post"]},{"Name":"UserController","FullName":"NetCorePal.Web.Controllers.UserController","Methods":["CreateUser","Login","Empty","JwtLogin","Jwt"]}],"Commands":[{"Name":"CreateOrderCommand","FullName":"NetCorePal.Web.Application.Commands.CreateOrderCommand","Properties":[]},{"Name":"DeleteOrderCommand","FullName":"NetCorePal.Web.Application.Commands.DeleteOrderCommand","Properties":[]},{"Name":"DeliverGoodsCommand","FullName":"NetCorePal.Web.Application.Commands.DeliverGoodsCommand","Properties":[]},{"Name":"OrderPaidCommand","FullName":"NetCorePal.Web.Application.Commands.OrderPaidCommand","Properties":[]},{"Name":"SetOrderItemNameCommand","FullName":"NetCorePal.Web.Application.Commands.SetOrderItemNameCommand","Properties":[]},{"Name":"GetOrderByNameQuery","FullName":"NetCorePal.Web.Application.Queries.GetOrderByNameQuery","Properties":[]}],"Entities":[{"Name":"DeliverRecord","FullName":"NetCorePal.Web.Domain.DeliverRecord","IsAggregateRoot":true,"Methods":[]},{"Name":"Order","FullName":"NetCorePal.Web.Domain.Order","IsAggregateRoot":true,"Methods":["OrderPaid","SoftDelete","ChangeItemName"]}],"DomainEvents":[{"Name":"OrderCreatedDomainEvent","FullName":"NetCorePal.Web.Domain.DomainEvents.OrderCreatedDomainEvent","Properties":[]}],"DomainEventHandlers":[{"Name":"OrderCreatedDomainEventHandler","FullName":"NetCorePal.Web.Application.DomainEventHandlers.OrderCreatedDomainEventHandler","HandledEventType":"NetCorePal.Web.Domain.DomainEvents.OrderCreatedDomainEvent","Commands":[]}],"IntegrationEvents":[{"Name":"OrderCreatedIntegrationEvent","FullName":"NetCorePal.Web.Application.IntegrationEventHandlers.OrderCreatedIntegrationEvent"},{"Name":"OrderPaidIntegrationEvent","FullName":"NetCorePal.Web.Application.IntegrationEventHandlers.OrderPaidIntegrationEvent"}],"IntegrationEventHandlers":[{"Name":"OrderCreatedIntegrationEventHandler","FullName":"NetCorePal.Web.Application.IntegrationEventHandlers.OrderCreatedIntegrationEventHandler","HandledEventType":"NetCorePal.Web.Application.IntegrationEventHandlers.OrderCreatedIntegrationEvent"},{"Name":"OrderPaidIntegrationEventHandler","FullName":"NetCorePal.Web.Application.IntegrationEventHandlers.OrderPaidIntegrationEventHandler","HandledEventType":"NetCorePal.Web.Application.IntegrationEventHandlers.OrderPaidIntegrationEvent"}],"IntegrationEventConverters":[{"Name":"OrderCreatedIntegrationEventConverter","FullName":"NetCorePal.Web.Application.IntegrationConverters.OrderCreatedIntegrationEventConverter","DomainEventType":"NetCorePal.Web.Domain.DomainEvents.OrderCreatedDomainEvent","IntegrationEventType":"NetCorePal.Web.Application.IntegrationEventHandlers.OrderCreatedIntegrationEvent"}],"Relationships":[{"SourceType":"NetCorePal.Web.Application.Commands.DeleteOrderCommand","SourceMethod":"Handle","TargetType":"NetCorePal.Web.Domain.Order","TargetMethod":"SoftDelete","CallType":"CommandToAggregateMethod"},{"SourceType":"NetCorePal.Web.Application.Commands.OrderPaidCommand","SourceMethod":"Handle","TargetType":"NetCorePal.Web.Domain.Order","TargetMethod":"OrderPaid","CallType":"CommandToAggregateMethod"},{"SourceType":"NetCorePal.Web.Application.Commands.SetOrderItemNameCommand","SourceMethod":"Handle","TargetType":"NetCorePal.Web.Domain.Order","TargetMethod":"ChangeItemName","CallType":"CommandToAggregateMethod"},{"SourceType":"NetCorePal.Web.Domain.DomainEvents.OrderCreatedDomainEvent","SourceMethod":"","TargetType":"NetCorePal.Web.Application.DomainEventHandlers.OrderCreatedDomainEventHandler","TargetMethod":"HandleAsync","CallType":"DomainEventToHandler"},{"SourceType":"NetCorePal.Web.Application.DomainEventHandlers.OrderCreatedDomainEventHandler","SourceMethod":"Handle","TargetType":"NetCorePal.Web.Application.Commands.DeliverGoodsCommand","TargetMethod":"","CallType":"MethodToCommand"},{"SourceType":"NetCorePal.Web.Domain.DomainEvents.OrderCreatedDomainEvent","SourceMethod":"","TargetType":"NetCorePal.Web.Application.IntegrationEventHandlers.OrderCreatedIntegrationEvent","TargetMethod":"","CallType":"DomainEventToIntegrationEvent"},{"SourceType":"NetCorePal.Web.Application.IntegrationEventHandlers.OrderCreatedIntegrationEvent","SourceMethod":"","TargetType":"NetCorePal.Web.Application.IntegrationEventHandlers.OrderCreatedIntegrationEventHandler","TargetMethod":"Subscribe","CallType":"IntegrationEventToHandler"},{"SourceType":"NetCorePal.Web.Application.IntegrationEventHandlers.OrderPaidIntegrationEvent","SourceMethod":"","TargetType":"NetCorePal.Web.Application.IntegrationEventHandlers.OrderPaidIntegrationEventHandler","TargetMethod":"Subscribe","CallType":"IntegrationEventToHandler"},{"SourceType":"NetCorePal.Web.Application.IntegrationEventHandlers.OrderPaidIntegrationEventHandler","SourceMethod":"HandleAsync","TargetType":"NetCorePal.Web.Application.Commands.OrderPaidCommand","TargetMethod":"","CallType":"MethodToCommand"},{"SourceType":"NetCorePal.Web.Controllers.OrderController","SourceMethod":"Post","TargetType":"NetCorePal.Web.Application.Commands.CreateOrderCommand","TargetMethod":"","CallType":"MethodToCommand"},{"SourceType":"NetCorePal.Web.Controllers.OrderController","SourceMethod":"SetPaid","TargetType":"NetCorePal.Web.Application.Commands.OrderPaidCommand","TargetMethod":"","CallType":"MethodToCommand"},{"SourceType":"NetCorePal.Web.Controllers.OrderController","SourceMethod":"SetOrderItemName","TargetType":"NetCorePal.Web.Application.Commands.SetOrderItemNameCommand","TargetMethod":"","CallType":"MethodToCommand"},{"SourceType":"NetCorePal.Web.Controllers.OrderController","SourceMethod":"QueryOrderByName","TargetType":"NetCorePal.Web.Application.Queries.GetOrderByNameQuery","TargetMethod":"","CallType":"MethodToCommand"},{"SourceType":"NetCorePal.Web.Controllers.OrderController","SourceMethod":"DeleteOrder","TargetType":"NetCorePal.Web.Application.Commands.DeleteOrderCommand","TargetMethod":"","CallType":"MethodToCommand"}]}
         */
    }
}

